---
- name: Playbook to export alcatel switch configuration to a Samba folder
  hosts: alcatel
  connection: local
  roles:
    - gmoisio.ale_aos
  vars:
    ansible_python_interpreter: "python"
  tasks:
    - name: Get configuration from switch
      ale_aos_command:
        host: "{{ inventory_hostname }}"
        username: "{{ switch_username }}"
        password: "{{ switch_password }}"
        timing: True
        command: "show configuration snapshot"
      register: config
    - name: Create a configuration file
      copy:
        content: "{{ config.output }}"
        dest: "/home/public/export_conf_brutes/{{ inventory_hostname }}.cfg"
    - name: Copy configuration file to Samba Folder
      ansible.builtin.command:
        argv:
          - sambaclient
          - "{{ samba_share }}"
          - '-c ''cd "{{ source_folder }}" ; put "/home/public/export_conf_brutes/{{ inventory_hostname }}.cfg" "{{ inventory_hostname }}.cfg"'''
          - "-U 'PBNA\\{{ smb_user }}%{{ smb_password }}'"
    - name: Delete file on local storage
      ansible.builtin.command:
        cmd: rm -rf /home/public/export_conf_brutes/{{ inventory_hostname }}.cfg
